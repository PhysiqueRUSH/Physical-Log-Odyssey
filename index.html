<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physical Log Odyssey</title>
    <link rel="icon" type="image/png" href="./plo-ico.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
        /* Inputs cleanup */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col font-sans">

    <header class="bg-blue-600 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold tracking-wide">Physical Log Odyssey</h1>
        <img src="./plo-ico.png" alt="Logo" class="w-8 h-8 rounded bg-white p-0.5">
    </header>

    <main id="app" class="flex-1 overflow-y-auto p-4 pb-24 relative">
        </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around p-3 shadow-lg z-20 pb-safe">
        <button onclick="router('log')" class="nav-btn flex flex-col items-center text-slate-500 hover:text-blue-600 transition" id="nav-log">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <span class="text-xs mt-1">Saisie</span>
        </button>
        <button onclick="router('history')" class="nav-btn flex flex-col items-center text-slate-500 hover:text-blue-600 transition" id="nav-history">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span class="text-xs mt-1">Historique</span>
        </button>
        <button onclick="router('stats')" class="nav-btn flex flex-col items-center text-slate-500 hover:text-blue-600 transition" id="nav-stats">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
            <span class="text-xs mt-1">Graphiques</span>
        </button>
        <button onclick="router('settings')" class="nav-btn flex flex-col items-center text-slate-500 hover:text-blue-600 transition" id="nav-settings">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-xs mt-1">Gestion</span>
        </button>
    </nav>

    <script>
        // --- DATA ---
        const DB_KEY = 'physical_log_odyssey_v1';
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || { users: [], exercises: [], logs: [] };
        const saveDb = () => localStorage.setItem(DB_KEY, JSON.stringify(db));

        // --- UTILS ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const calculate1RM = (weight, reps) => {
            if(!weight || !reps) return 0;
            if(reps === 1) return weight;
            return Math.round((weight * (1 + reps / 30)) * 10) / 10;
        };

        const formatDate = (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // Helper to get ISO week string "YYYY-Www" from a date string
        const getIsoWeek = (dateStr) => {
            const d = new Date(dateStr);
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            const week = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return `${date.getFullYear()}-W${week.toString().padStart(2, '0')}`;
        };

        // Generates distinct colors based on index using Golden Angle
        const getColor = (index) => {
            const hue = (index * 137.508) % 360; 
            return `hsl(${hue}, 70%, 50%)`;
        };

        // --- ROUTER ---
        const app = document.getElementById('app');
        let currentChart = null; 
        let chartScaleZero = false;

        function highlightNav(route) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-600'));
            const activeBtn = document.getElementById('nav-' + route);
            if(activeBtn) activeBtn.classList.add('text-blue-600');
        }

        function router(route) {
            app.innerHTML = '';
            app.className = "flex-1 overflow-y-auto p-4 pb-24 relative fade-in";
            highlightNav(route);
            if (route === 'log') renderLogView();
            else if (route === 'history') renderHistoryView();
            else if (route === 'stats') renderStatsView();
            else if (route === 'settings') renderSettingsView();
        }

        // 1. LOG VIEW
        function renderLogView(editLogId = null) {
            if(db.users.length === 0 || db.exercises.length === 0) {
                app.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6">
                        <div class="bg-yellow-100 text-yellow-800 p-6 rounded-lg shadow-sm">
                            <p class="font-bold text-lg mb-2">Configuration requise</p>
                            <p>Veuillez créer au moins un athlète et un exercice dans l'onglet <strong>Gestion</strong>.</p>
                            <button onclick="router('settings')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded shadow">Allez à la Gestion</button>
                        </div>
                    </div>`;
                return;
            }

            let logToEdit = editLogId ? db.logs.find(l => l.id === editLogId) : null;
            const today = new Date().toISOString().split('T')[0];
            
            const form = document.createElement('div');
            form.className = "space-y-5 max-w-lg mx-auto";
            form.innerHTML = `
                <h2 class="text-2xl font-bold text-slate-800 mb-6">${logToEdit ? 'Modifier Performance' : 'Nouvelle Performance'}</h2>
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Date</label>
                        <input type="date" id="inputDate" value="${logToEdit ? logToEdit.date : today}" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Athlète</label>
                        <select id="inputUser" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            ${db.users.map(u => `<option value="${u.id}" ${logToEdit && logToEdit.userId === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Exercice</label>
                        <select id="inputEx" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" onchange="toggleInputs(this.value)">
                             ${db.exercises.map(e => `<option value="${e.id}" data-type="${e.type}" ${logToEdit && logToEdit.exId === e.id ? 'selected' : ''}>${e.name} (${e.type === 'cardio' ? 'C' : 'M'})</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div id="strengthInputs" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Poids (kg)</label>
                            <input type="number" step="0.5" id="inputWeight" value="${logToEdit ? logToEdit.weight || '' : ''}" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 font-mono text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Répétitions</label>
                            <input type="number" id="inputReps" value="${logToEdit ? logToEdit.reps || '' : ''}" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 font-mono text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                    <div id="cardioInputs" class="hidden">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Distance (km)</label>
                        <input type="number" step="0.01" id="inputDist" placeholder="ex: 1.68" value="${logToEdit ? logToEdit.distance || '' : ''}" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 font-mono text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div id="rmPreview" class="mt-4 p-3 bg-blue-50 rounded-lg text-center hidden">
                        <span class="text-sm text-blue-600 font-semibold">Max Théorique (Epley)</span>
                        <div class="text-2xl font-bold text-blue-800"><span id="rmValue">--</span> <span class="text-sm">kg</span></div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Commentaire</label>
                    <textarea id="inputComment" rows="2" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">${logToEdit ? logToEdit.comment || '' : ''}</textarea>
                </div>

                <div class="pt-2">
                    <button id="saveBtn" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-95 flex justify-center items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        <span>${logToEdit ? 'Mettre à jour' : 'Enregistrer'}</span>
                    </button>
                    ${logToEdit ? `<button onclick="router('history')" class="w-full text-slate-500 mt-4 py-2 hover:text-red-500 transition">Annuler</button>` : ''}
                </div>
            `;
            app.appendChild(form);

            // Inputs Logic
            const exSelect = document.getElementById('inputEx');
            const wInput = document.getElementById('inputWeight');
            const rInput = document.getElementById('inputReps');
            
            window.toggleInputs = (exId) => {
                const ex = db.exercises.find(e => e.id === exId);
                if(!ex) return;
                const sDiv = document.getElementById('strengthInputs');
                const cDiv = document.getElementById('cardioInputs');
                const rmPreview = document.getElementById('rmPreview');
                if (ex.type === 'cardio') {
                    sDiv.classList.add('hidden');
                    rmPreview.classList.add('hidden');
                    cDiv.classList.remove('hidden');
                } else {
                    sDiv.classList.remove('hidden');
                    cDiv.classList.add('hidden');
                    rmPreview.classList.remove('hidden');
                }
            };

            const updateRM = () => {
                const w = parseFloat(wInput.value);
                const r = parseFloat(rInput.value);
                if(w && r) {
                    const rm = calculate1RM(w, r);
                    document.getElementById('rmValue').textContent = rm;
                    document.getElementById('rmPreview').classList.remove('hidden');
                } else document.getElementById('rmPreview').classList.add('hidden');
            };

            wInput.addEventListener('input', updateRM);
            rInput.addEventListener('input', updateRM);
            
            if(db.exercises.length > 0) {
                toggleInputs(exSelect.value); 
                updateRM();
            }

            document.getElementById('saveBtn').onclick = () => {
                const exId = exSelect.value;
                const ex = db.exercises.find(e => e.id === exId);
                const newLog = {
                    id: logToEdit ? logToEdit.id : generateId(),
                    date: document.getElementById('inputDate').value,
                    userId: document.getElementById('inputUser').value,
                    exId: exId,
                    comment: document.getElementById('inputComment').value,
                    timestamp: Date.now()
                };

                if(ex.type === 'strength') {
                    newLog.weight = parseFloat(wInput.value);
                    newLog.reps = parseFloat(rInput.value);
                    newLog.rm1 = calculate1RM(newLog.weight, newLog.reps);
                    if(!newLog.weight || !newLog.reps) { alert("Champs Poids/Reps requis"); return; }
                } else {
                    newLog.distance = parseFloat(document.getElementById('inputDist').value);
                    if(!newLog.distance) { alert("Distance requise"); return; }
                }

                if(logToEdit) {
                    const idx = db.logs.findIndex(l => l.id === logToEdit.id);
                    db.logs[idx] = newLog;
                } else db.logs.push(newLog);
                
                saveDb();
                router('history');
            };
        }

        // 2. HISTORY VIEW (Avec Filtres)
        function renderHistoryView() {
            const container = document.createElement('div');
            container.className = "max-w-lg mx-auto pb-10";
            
            // Header + Filters
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Historique</h2>
                
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-4 grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400">Filtrer par Mois</label>
                        <input type="month" id="filterMonth" class="w-full text-sm p-1 bg-slate-50 border border-slate-200 rounded">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400">Filtrer par Semaine</label>
                        <input type="week" id="filterWeek" class="w-full text-sm p-1 bg-slate-50 border border-slate-200 rounded">
                    </div>
                    <button id="clearFilters" class="col-span-2 text-xs text-blue-600 font-semibold py-1 border border-blue-100 bg-blue-50 rounded mt-1 hidden">
                        Voir tout l'historique
                    </button>
                </div>
                <div id="logsList"></div>
            `;
            app.appendChild(container);

            const logsListEl = document.getElementById('logsList');
            const filterMonthEl = document.getElementById('filterMonth');
            const filterWeekEl = document.getElementById('filterWeek');
            const clearBtn = document.getElementById('clearFilters');

            const renderLogs = (logs) => {
                logsListEl.innerHTML = '';
                if(logs.length === 0) {
                    logsListEl.innerHTML = `<p class="text-center text-slate-400 py-6 italic">Aucune donnée pour cette sélection.</p>`;
                    return;
                }
                logs.forEach(log => {
                    const user = db.users.find(u => u.id === log.userId)?.name || 'Inconnu';
                    const ex = db.exercises.find(e => e.id === log.exId);
                    const exName = ex?.name || 'Supprimé';
                    
                    let details, badge;
                    if(ex && ex.type === 'strength') {
                        details = `<span class="text-lg font-bold text-slate-800">${log.weight}kg <span class="text-sm text-slate-500 font-normal">x ${log.reps}</span></span>`;
                        if(log.rm1) details += `<div class="text-xs text-blue-600 font-bold mt-1">RM: ${log.rm1}kg</div>`;
                        badge = `<span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded-full">MUSCU</span>`;
                    } else {
                        // FORCE 2 decimals for display
                        details = `<span class="text-lg font-bold text-slate-800">${log.distance.toFixed(2)} km</span>`;
                        badge = `<span class="bg-green-100 text-green-800 text-[10px] font-bold px-2 py-0.5 rounded-full">CARDIO</span>`;
                    }

                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4 relative overflow-hidden";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-slate-400">${formatDate(log.date)}</span>
                                <span class="text-xs font-bold text-slate-600 px-2 py-0.5 bg-slate-100 rounded">${user}</span>
                            </div>
                            ${badge}
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <h3 class="font-bold text-slate-700 text-base mb-1 leading-tight">${exName}</h3>
                                ${details}
                                ${log.comment ? `<p class="mt-2 text-sm text-slate-500 italic border-l-2 border-slate-200 pl-2">"${log.comment}"</p>` : ''}
                            </div>
                            <div class="flex gap-3">
                                <button onclick="deleteLog('${log.id}')" class="p-2 text-red-300 hover:text-red-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                <button onclick="editLog('${log.id}')" class="p-2 text-blue-400 hover:text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            </div>
                        </div>
                    `;
                    logsListEl.appendChild(card);
                });
            };

            const applyFilters = () => {
                let filtered = [...db.logs].sort((a,b) => new Date(b.date) - new Date(a.date));
                const monthVal = filterMonthEl.value;
                const weekVal = filterWeekEl.value;

                if (monthVal) {
                    filtered = filtered.filter(l => l.date.substring(0, 7) === monthVal);
                    filterWeekEl.value = ''; // Reset week if month selected
                    clearBtn.classList.remove('hidden');
                } else if (weekVal) {
                    filtered = filtered.filter(l => getIsoWeek(l.date) === weekVal);
                    filterMonthEl.value = ''; // Reset month if week selected
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
                renderLogs(filtered);
            };

            filterMonthEl.addEventListener('change', applyFilters);
            filterWeekEl.addEventListener('change', applyFilters);
            clearBtn.addEventListener('click', () => {
                filterMonthEl.value = '';
                filterWeekEl.value = '';
                applyFilters();
            });

            // Initial render
            applyFilters();
        }

        window.editLog = (id) => renderLogView(id);
        window.deleteLog = (id) => {
            if(confirm("Supprimer ?")) {
                db.logs = db.logs.filter(l => l.id !== id);
                saveDb();
                router('history');
            }
        };

        // 3. STATS VIEW (Multi-User Charts)
        function renderStatsView() {
            const container = document.createElement('div');
            container.className = "max-w-lg mx-auto h-full flex flex-col space-y-4";
            
            container.innerHTML = `<h2 class="text-2xl font-bold text-slate-800">Comparateur</h2>`;
            if(db.logs.length === 0) {
                 container.innerHTML += `<p class="text-slate-500">Aucune donnée disponible.</p>`;
                 app.appendChild(container); return;
            }

            // Controls (Exercise Only)
            const controls = document.createElement('div');
            controls.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100";
            controls.innerHTML = `
                 <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Choisir l'exercice</label>
                 <select id="statEx" class="block w-full rounded-lg border-slate-200 bg-slate-50 p-2 text-sm focus:ring-2 focus:ring-blue-500 mb-3">
                    ${db.exercises.filter(e => e.type === 'strength').map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                 </select>
                
                <div class="flex items-center justify-between border-t border-slate-100 pt-3">
                    <span class="text-sm font-medium text-slate-600">Échelle Graphique</span>
                    <div class="flex items-center">
                        <span class="mr-2 text-xs text-slate-400">${chartScaleZero ? 'Absolu (0)' : 'Zoomé'}</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" id="scaleToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" ${chartScaleZero ? 'checked' : ''}/>
                            <label for="scaleToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(controls);

            // Chart
            const chartWrapper = document.createElement('div');
            chartWrapper.className = "bg-white p-2 rounded-xl shadow-md flex-1 relative min-h-[400px] border border-slate-100";
            chartWrapper.innerHTML = `<canvas id="perfChart"></canvas>`;
            container.appendChild(chartWrapper);
            app.appendChild(container);

            const ctx = document.getElementById('perfChart').getContext('2d');
            
            const updateChart = () => {
                const exId = document.getElementById('statEx').value;
                const exName = db.exercises.find(e => e.id === exId)?.name;
                
                // DATA PREPARATION FOR MULTI-USER
                const datasets = [];
                let allLabels = new Set();

                db.users.forEach((user, index) => {
                    // Filter logs for this user AND this exercise
                    const userLogs = db.logs
                        .filter(l => l.userId === user.id && l.exId === exId && l.rm1 > 0)
                        .sort((a,b) => new Date(a.date) - new Date(b.date));
                    
                    if(userLogs.length >= 1) {
                        userLogs.forEach(l => allLabels.add(l.date));
                        datasets.push({
                            label: user.name,
                            data: userLogs.map(l => ({x: l.date, y: l.rm1})), // Use Object for sparse data
                            borderColor: getColor(index),
                            backgroundColor: getColor(index),
                            borderWidth: 2,
                            pointRadius: 4,
                            tension: 0.3,
                            fill: false
                        });
                    }
                });

                // Sort labels chronologically
                const sortedLabels = Array.from(allLabels).sort((a,b) => new Date(a) - new Date(b));

                if(currentChart) currentChart.destroy();

                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedLabels.map(d => formatDate(d)),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: { usePointStyle: true, boxWidth: 8 }
                            },
                            title: {
                                display: true,
                                text: datasets.length === 0 ? 'Aucune donnée' : `Comparatif : ${exName}`,
                                font: { size: 14 }
                            },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => ctx[0].label // Show date
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: chartScaleZero,
                                title: { display: true, text: 'Max Estimé (kg)' }
                            },
                            x: {
                                type: 'category', // Simple category scale using sorted unique dates
                                labels: sortedLabels.map(d => formatDate(d))
                            }
                        }
                    }
                });
            };

            // Events
            document.getElementById('statEx').addEventListener('change', updateChart);
            document.getElementById('scaleToggle').addEventListener('change', (e) => {
                chartScaleZero = e.target.checked;
                e.target.parentNode.previousElementSibling.textContent = chartScaleZero ? 'Absolu (0)' : 'Zoomé';
                updateChart();
            });

            if(db.exercises.some(e => e.type === 'strength')) updateChart();
        }

        // 4. SETTINGS VIEW
        function renderSettingsView() {
            const container = document.createElement('div');
            container.className = "max-w-lg mx-auto space-y-6";
            
            container.innerHTML = `<h2 class="text-2xl font-bold text-slate-800 mb-2">Gestion</h2>`;

            // Users
            const userSection = document.createElement('div');
            userSection.className = "bg-white p-5 rounded-xl shadow-sm border border-slate-100";
            userSection.innerHTML = `
                <h3 class="font-bold text-slate-700 mb-3">Athlètes</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newUserName" placeholder="Nom..." class="flex-1 rounded-lg border-slate-200 bg-slate-50 p-2 text-sm">
                    <button id="addUserBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg">+</button>
                </div>
                <ul class="space-y-2 max-h-48 overflow-y-auto">
                    ${db.users.map(u => `
                        <li class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <span class="font-medium text-slate-700">${u.name}</span>
                            <button onclick="deleteUser('${u.id}')" class="text-red-300 hover:text-red-500">Suppr.</button>
                        </li>
                    `).join('')}
                </ul>`;
            container.appendChild(userSection);

            // Exercises
            const exSection = document.createElement('div');
            exSection.className = "bg-white p-5 rounded-xl shadow-sm border border-slate-100";
            exSection.innerHTML = `
                <h3 class="font-bold text-slate-700 mb-3">Exercices</h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newExName" placeholder="Nom..." class="flex-1 rounded-lg border-slate-200 bg-slate-50 p-2 text-sm">
                    <select id="newExType" class="rounded-lg border-slate-200 bg-slate-50 p-2 text-sm">
                        <option value="strength">Muscu</option>
                        <option value="cardio">Cardio</option>
                    </select>
                </div>
                <button id="addExBtn" class="w-full bg-blue-600 text-white p-2 rounded-lg text-sm font-semibold mb-4">Ajouter</button>
                <ul class="space-y-2 max-h-48 overflow-y-auto">
                    ${db.exercises.map(e => `
                        <li class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <div><span class="font-medium text-slate-700">${e.name}</span> <span class="text-[10px] uppercase text-slate-400">${e.type === 'cardio' ? 'C' : 'M'}</span></div>
                            <button onclick="deleteExercise('${e.id}')" class="text-red-300 hover:text-red-500">Suppr.</button>
                        </li>
                    `).join('')}
                </ul>`;
            container.appendChild(exSection);
            
            container.innerHTML += `<div class="text-center text-xs text-slate-400 mt-6">v4.0 • Epley • Multi-Graph</div>`;
            app.appendChild(container);

            // Handlers
            document.getElementById('addUserBtn').onclick = () => {
                const name = document.getElementById('newUserName').value.trim();
                if(name) { db.users.push({ id: generateId(), name }); saveDb(); renderSettingsView(); }
            };
            document.getElementById('addExBtn').onclick = () => {
                const name = document.getElementById('newExName').value.trim();
                const type = document.getElementById('newExType').value;
                if(name) { db.exercises.push({ id: generateId(), name, type }); saveDb(); renderSettingsView(); }
            };

            window.deleteUser = (id) => {
                if(confirm("Supprimer l'athlète et tout son historique ?")) {
                    db.users = db.users.filter(u => u.id !== id);
                    db.logs = db.logs.filter(l => l.userId !== id);
                    saveDb(); renderSettingsView();
                }
            };
            window.deleteExercise = (id) => {
                if(confirm("Supprimer l'exercice et historique associé ?")) {
                    db.exercises = db.exercises.filter(e => e.id !== id);
                    db.logs = db.logs.filter(l => l.exId !== id);
                    saveDb(); renderSettingsView();
                }
            };
        }

        // SW Init
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        router('log');
    </script>
</body>
</html>
